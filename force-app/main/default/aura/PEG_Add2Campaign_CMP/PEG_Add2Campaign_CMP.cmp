<aura:component implements="flexipage:availableForRecordHome,force:hasRecordId,force:hasSObjectName"
                access="global"
                description="Lightning component to add Leads / Contacts to a campaign based on an Einstein Analytics dashboard selection">
	
<!--
@author P-E GROS
@date   April 2020

Legal Notice
This code is the property of Salesforce.com and is protected by U.S. and International
copyright laws. Reproduction, distribution without written permission of Salesforce is
strictly prohibited. In particular this code has been delivered by Salesforce.com for
its Clientâ€™s internal purposes pursuant to specific terms and conditions, and cannot be
re-used, reproduced or distributed for any other purposes.
-->
    
    <!-- Component Configuration -->
    <aura:attribute name="title"			type="String"
                    access="global" 		
                    description="Title of the component." />
    <aura:attribute name="icon"				type="String"
                    access="global" 		
                    description="Icon of the component." />
    <aura:attribute name="actionLabel"		type="String"
                    access="global" 		default="Add Participants"
                    description="Label of the 'add to campaign' action button." />
    
    <aura:attribute name="dashboardName"	type="String"
                    access="global"
                    description="Developer Name of the EA Dashboard to be displayed."/>
    <aura:attribute name="dashboardHeight"	type="Integer"
                    access="global"			default="300"
                    description="Height in pixels of the Dashboard."/>
    
    <aura:attribute name="datasetName"		type="String"
                    access="global"
                    description="Developer Name of the EA Dataset to be used (when multiple in dashboard)."/>
    <aura:attribute name="idFieldName"		type="String"
                    access="global"			default="Id"
                    description="API Name of the Member ID field in the EA dataset to be used." />
    <aura:attribute name="useGroup"			type="Boolean"
                    access="global"			default="false"
                    description='Flag to add a "group by" saql statement to fetch the member IDs in the EA dataset.' />

    <aura:attribute name="memberType"		type="String"
                    access="global" 		default="Contact"
                    description="Type of Campaign member to be created (Lead or Contact)." />
    <aura:attribute name="refreshTab"		type="Boolean"
                    access="global"			default="false"
                    description="Flag to trigger a tab refresh after addition of new campaign members."/>
    <aura:attribute name="showDebug"		type="Boolean"
                    access="global"			default="false"
                    description="Show debug details."/>
    
    <!-- Component technical lifecycle control attributes -->    
    <aura:attribute name="dashboardId"		type="String"
                    access="private"
                    description="ID of the Wave Dashboard to be displayed."/>
    <aura:attribute name="datasetId"		type="String"
                    access="private"
                    description="ID of the Wave Dashboard to be displayed."/>
    
    <aura:attribute name="dbReady"			type="Boolean"
                    access="private"		default="false"
                    description="DB loading state to finalize init."/>
    
    <aura:attribute name="dbDesc"			type="Object"
                    access="private"
                    description="DB description."/>
    <aura:attribute name="dsDesc"			type="Object"
                    access="private"
                    description="DS description."/>
    <aura:attribute name="dsFieldDesc"		type="Object"
                    access="private"
                    description="DS fields description."/>
    
    <aura:attribute name="ds2fetch"			type="Integer"
                    access="private"		default="0"
                    description="Number of DS desc remaining to load."/>
    <aura:attribute name="initDone"			type="Boolean"
                    access="private"		default="false"
                    description="Component init finished."/>
    
    <!-- Component technical action control attributes -->
    <aura:attribute name="isRunning"		type="Boolean"
                    access="private"		default="false"
                    description="Action running."/>
    <aura:attribute name="saqlIdList"		type="List"
                    access="private"
                    description="List of IDs extracted from EA."/>
    <aura:attribute name="soqlIdList"		type="List"
                    access="private"
                    description="List of IDs (to be) added in Campaign."/>
    <aura:attribute name="runStep"			type="String"
                    access="private"		default="0"
                    description="Progress bar step."/>
    <aura:attribute name="actionError"		type="String"
                    access="private"
                    description="Action error."/>
    
    <!-- Component debug attributes -->    
    <aura:attribute name="saqlQuery"		type="String"
                    access="private"
                    description="SAQL Query generated."/>
    <aura:attribute name="saqlResults"		type="String"
                    access="private"
                    description="SAQL results received."/>
    <aura:attribute name="soqlQuery"		type="String"
                    access="private"
                    description="SOQL Query generated."/>
    
    <!-- Component Initialisation -->
    <aura:handler	name="init"			value="{!this}"
					action="{!c.handleInit}"
					description="Init of component (EA description requests)."/>
    <aura:handler	name="change"		value="{!v.dbReady}"
                  	action="{!c.handleDBLoaded}"
                  	description="Finalisation of the component init."/>

	<!-- Utilities -->    
    <wave:sdk 						aura:id="analyticsSDK"/>
    <c:PEG_SOQL_CMP					aura:id="soqlUtil"/>
    
    <!-- Component Display -->
    <lightning:card title="{!v.title}" iconName="{#v.icon}">
        
        <!-- Action trigger button -->
        <aura:set attribute="actions">          
    		<lightning:button variant="neutral"	label="{!v.actionLabel}"
                          	title="{!v.actionLabel}"  disabled="{! or(!v.initDone,v.isRunning)}"	
                          	onclick="{!c.add2Campaign}"/>
        </aura:set>
        
        <!-- Debug section -->
        <aura:set attribute="footer">
            <aura:if isTrue="{#v.showDebug}">
            	<div class="slds-text-align_left">
                <dl class="slds-list_horizontal slds-wrap">
                  <dt class="slds-item_label slds-text-color_weak slds-truncate slds-text-align_right" >
                      <lightning:icon iconName="utility:info_alt" alternativeText="Information" size="x-small" title="Information" /></dt>
                  <dd class="slds-item_detail slds-text-align_left" >
                      <a href="/docs/component-library/bundle/c:PEG_Add2Campaign_CMP/documentation">
                        Access documentation.</a></dd>
                  <dt class="slds-item_label slds-text-color_weak slds-truncate slds-text-align_right" >
                        DB Name / ID </dt>
            		  <dd class="slds-item_detail slds-text-align_left" >
                        {!v.dashboardName} / {!v.dashboardId}</dd>
                  <dt class="slds-item_label slds-text-color_weak slds-truncate slds-text-align_right" >
                		  DS Name / ID</dt>
            		  <dd class="slds-item_detail slds-text-align_left" >
                		  {!v.datasetName} / {!v.datasetId}</dd>
                  <dt class="slds-item_label slds-text-color_weak slds-truncate slds-text-align_right" >
                      ID field / Use Group</dt>
            		  <dd class="slds-item_detail slds-text-align_left">
                      {#v.idFieldName} / {#v.useGroup} </dd>
                  <dt class="slds-item_label slds-text-color_weak slds-truncate slds-text-align_right" >
                		  SAQL query</dt>
            		  <dd class="slds-item_detail slds-text-align_left" >
                		  {!v.saqlQuery}</dd>
                  <dt class="slds-item_label slds-text-color_weak slds-truncate slds-text-align_right" >
                		  SAQL results</dt>
            		  <dd class="slds-item_detail slds-text-align_left" >
                		  {!v.saqlResults.results.records.length}</dd>
                      <dt class="slds-item_label slds-text-color_weak slds-truncate slds-text-align_right" >
                		  IDs from SAQL</dt>
            		  <dd class="slds-item_detail slds-text-align_left" >
                		  {!v.saqlIdList.length}</dd>
                  <dt class="slds-item_label slds-text-color_weak slds-truncate slds-text-align_right" >
                		  SOQL query</dt>
            		  <dd class="slds-item_detail slds-text-align_left" >
                		  {!v.soqlQuery}</dd>
                  <dt class="slds-item_label slds-text-color_weak slds-truncate slds-text-align_right" >
                		  IDs filtered</dt>
            	  	<dd class="slds-item_detail slds-text-align_left" >
                		  {!v.soqlIdList.length}</dd>
                </dl>
            </div>
            </aura:if>
        </aura:set>
        
        <!-- Action popup -->
        <aura:if isTrue="{!v.isRunning}">
            <div class="modal-glass slds-backdrop fadein slds-backdrop--open"
                 tabindex="-1" data-aura-rendered-by="3230:0" style="opacity: 0.8;">
            </div>
            <section role="dialog" aria-label="Confirmation Popup" aria-modal="true" aria-describedby="modal-content-id-1" class="slds-modal slds-fade-in-open">
        		<div class="slds-modal__container">
                   	<header class="slds-modal__header">
        				<lightning:progressIndicator	currentStep="{!v.runStep}"
                                       					type="base"	variant="base"
                                       					hasError="{!v.actionError.length > 0}" >
        					<lightning:progressStep value="1" label="Filter fetched"/>
        					<lightning:progressStep value="2" label="SAQL data fetched"/>
        					<lightning:progressStep value="3" label="SOQL data fetched"/>
        					<lightning:progressStep value="4" label="Members added"/>
    					</lightning:progressIndicator>
                   	</header>
                   	<div class="slds-modal__content slds-p-around_medium" id="modal-content-id-1">
                       	<aura:if isTrue="{!v.actionError.length > 0}">
                           	<div class="slds-text-align_left slds-text-color_destructive">
                           		{!v.actionError}</div>
                       	<aura:set attribute="else">
                          	<div class="slds-text-align_left slds-text-color_default">
                           		{!format($Label.c.PEG_Add2CampaignMessage, v.saqlIdList.length, v.soqlIdList.length)}</div>
                      	</aura:set>
                      	</aura:if>
                   	</div>
                   	<footer class="slds-modal__footer">
                       	<lightning:buttonIcon	iconName="utility:close"		variant="border-filled"
                                             	alternativeText="Cancel"		title="Cancel"
                                            	onclick="{!c.cancelAction}" />
           				<lightning:buttonIcon	iconName="utility:check"		variant="brand"
                                             	alternativeText="Validate"	title="Validate"
                                             	disabled="{! or(v.soqlIdList.length == 0, v.actionError.length > 0)}"
                                            	onclick="{!c.confirmAction}"/>
    				</footer>
               	</div>
           	</section>
        </aura:if>

        <!-- Main Dashboard Content -->
        <wave:waveDashboard aura:id="analyticsDB"
                            height="{#v.dashboardHeight}"
                            developerName="{#v.dashboardName}"
                            isLoaded="{!v.dbReady}"/>
        
	</lightning:card>
     
</aura:component>